# 바이낸스 DEX 거래 규격

## 주문

주문은 클라이언트가 토큰을 바이낸스 DEX에서 구매/판매하여 다른 토큰과 거래하는 요청입니다.
비컨 체인 트랜잭션의 표준 유형으로, 다음과 같은 매개 변수로 이루어져 있습니다.

0. Symbol Pairs(심볼 쌍): 거래하고자 하는 목록 쌍
1. Order Type(주문 타입): 바이낸스 DEX 는 SEC 정의를 준수하는 지정가(limit price) 주문만 가능합니다.
2. Price(가격): 특정한 토큰과 그 양에 따라 지불할 금액을 뜻하며, 견적 통화의 실수(float)값으로 표기합니다. 
틱 사이즈에 의해 반올림 되며, 내부적으로는 1e8(10^8)이 곱해져서 int64에서 표현될 수 있도록 나타냅니다.
3. Quantity(양): 매매하고 싶은 토큰의 양. 로트 사이즈에 의해 반올림 되어야 합니다. 내부적으로는 1e8(10^8)이 곱해져서 int64로 값을 표현될 수 있도록 나타냅니다.
4. Side(구매/판매): 구매나 판매 결정
5. Time(시간): 주문의 입장 시간으로, 블록 넘버(높이) 형태로 기록됩니다.
6. TimeInForce(시간 제한):

    * GTE: Good Till Expire로 만료 시간까지 유효한 주문입니다. 블록이 259,200 지났으면 UTC 자정에 주문이 만료되며, 시간으로 따지면 72시간에 해당합니다.
    * IOC: Immediate or Cancel로 즉시 거래 성립 또는 취소되는 주문입니다. 주문은 지정된 블록 시간 안에는 최대한 실행되며, 양이 남았을 시 거래가 취소됩니다.

주문이 기각되는 경우:

0. 유저 주소는 자산과 함께 위치하지 않습니다
1. 계정이 구매/판매를 위한 토큰을 충분히 보유하지 않는 경우
2. 거래소가 다운되거나 매칭에 문제가 있는 경우
3. 토큰이 기초 자산에 대해 상장되어 있지 않은 경우
4. 다른 주문 매개 변수가 유효하지 않을 때
5. 주문 ID가 중복되었을 때

주문이 취소/만료되는 경우:

1. IOC 주문이 전부 채워지지 않았을 때
2. 주문이 만료될 때
3. 거래소에서 주문 추가로 처리시 문제가 발생할 때

어떤 블록체인 노드에서 주문을 받았을 시, 노드는 합의에 의해 주문 트랜잭션을 블록에 넣어 제출합니다. 주문이 블럭에서 허용 될 시, 2가지가 발생합니다,

1. 주문으로 인해 전송될 수 있는 자산은 잠겨서 전송할 수 없게 됩니다.
2. 바이낸스 DEX가 현존하는 모든 주문이나 같은 블록의 주문에 대해 거래 매칭을 시도합니다.

만일 주문이 반대되는 쪽과 매칭이 가능할 때, 거래가 발생하며 자산이 전송됩니다. 
완전히 충족된 주문은 오더 북에서 제거되며, 충족되지 않거나 일부만 된 GTE 주문의 경우 다 채워질 때까지 오더북에 존재합니다. 
IOC 주문의 경우 바로 취소됩니다.

### 주문 수명 주기

매칭 엔진에 보내진 유효한 주문은 바로 확인되며 **Ack**(인지) 상태로 변화하고, 유효하지 않을 경우 **FailedMatching**(매칭 실패) 상태가 됩니다. GTE와 IOC 주문은 서로 다른 수명 주기를 지닙니다. 

IOC 주문은 반대 거래와 매칭되어 주문 전체가 바로 채워지면, 주문이 **FullyFill**(완전 충족)된 것으로 간주됩니다. IOC 주문은 부분적으로 실행 될 수 있으며 **IocExpire**(Ioc 만료) 상태로 끝날 수 있습니다. IOC 주문이 하나도 채워지지 않을 시, **IocNoFill** 상태로 반환됩니다.

GTE 주문은 반대 거래와 매칭되어 주문 전체가 바로 채워지면, 주문이 **FullyFill**(완전 충족)된 상태입니다. 주문 중 전부 체워지지 않은 부분이 있을 경우 열린 상태라고 간주됩니다. 주문은 취소되거나 새로운 주문을 통해 채워질 때까지 열린 상태로 존재합니다. 취소된 GTE 주문은 **Canceled** 상태입니다. 더 이상 매칭이 불가능한 주문은 **Expired**(만료) 상태가 됩니다.

### 주문 만료

주문은 블록으로 묶인 후 72시간이 지나면 만료됩니다. 전체 오더 북 스캔은 매 UTC 자정에 발생하며, 여기서 만료된 주문들을 거릅니다. 스캔이 끝난 후, 만료된 주문들은 오더 북에서 제거되며, 어카운트에 잠긴 금액이 해제됩니다. 이 작업 전에는 오더 북에 있는 모든 주문과 현재 존재하는 주문은 일치합니다.

!!! 팁
        [BEP-67](https://github.com/bnb-chain/BEPs/blob/master/BEP67.md)에서 논의되었듯, 요청 측과 입찰 측 양쪽의 최고 500 가격 레벨을 갖는 주문들은 72시간 대신 **30일** 이후에 만료됩니다. 단, 만료 수수료는 변하지 않습니다. BEP67는 테스트넷에서는 나이팅게일 업그레이드에서 구현된 후 계속 활성화 되어 있습니다. 비컨 체인 메인넷도 곧 업그레이드를 통해 BEP-67을 지원할 계획입니다.

## 정밀도

모든 수는 소수점 8자리로 제한됩니다.

## 틱(tick)사이즈와 로트(lot) 사이즈

틱 사이즈는 가격 변동의 최소 유닛을 나타내며, 로트 사이즈는 수량 변동의 최소 유닛을 나타냅니다.
주문 값은 1틱보다 크고 반올림되며, 주문량은 1로트 사이즈보다 크고 반올림됩니다. 그렇지 않을 경우 주문이 거절됩니다.

틱 사이즈와 로트 사이즈는 DEX API에서 쿼리할 수 있으며, DEX 매체 엔진에 의해 거래 가격에 따라 UTC 자정에 자동으로 검토되고 변경될 수 있습니다.
틱 사이즈나 로트 사이즈가 바꾼 후에는 새 주문은 새로운 값을 사용해야 하고, 오더 북에 있는 기존 주문은 기존 값에 따라 처리됩니다. 

## 수수료

5가지 종류의 주문 작업이 존재하며, 각 아래 표와 같이 구체적인 수수료 계산 논리와 수령 시기를 가지고 있습니다.


|    작업    |  계산  | 수집 시점 |
|:------------- |:------- |:------- |
| 주문 생성 | 무료 | - |
| 주문 취소 | 고정 수수료 | `Cancel` 트랜잭션이 실행될 때 |
| 주문 만료 | 완진히 만료될 시 고정 수수료, 그 외에는 무료 | 예약된 주문 만료가 발생할 때 |
| IOC 주문 취소| 완전 취소될 시 고정 수수료, 그 외에는 무료 | IOC 주문이 완전 성사되지 않을 시 |
| 주문 실행 | 비율 기반 수수료 | 주문이 성사될 시 |

수수료 수집 시 BNB가 우선 순위로 적용되며 수수료도 약간 할인됩니다.

DEX는 최신 잔고 상태와 사용자에게 유리한 방법으로 수수료를 계산하고 징수합니다.

### 메인넷의 현재 수수료 표

수수료는 변수이며 거버넌스 제안 및 투표에 의해 변경될 수 있습니다. 해당 수수료 표는 **2021-03-21** 메인넷 기준입니다:


트랜잭션 유형 | BNB 아닌 자산으로 결제 | BNB로 결제 | Exchange (DEX) 관련
-- | -- | -- | --
새 주문 | 0 | 0 | Y
취소 (No Fill) | Equivalent 0.00005 BNB | 0.00001 BNB | Y
Order Expire (No Fill) | Equivalent 0.00005 BNB | 0.00001 BNB | Y
IOC (No Fill) | Equivalent 0.00025 BNB | 0.000005 BNB | Y
전송 | N/A | 0.000075 BNB | N
crossTransferOut(크로스 전송)| N/A | 0.000075 BNB | N
Multi-send(다중 전송) | N/A | 0.00006 BNB | N
자산 발행 | N/A | 10 BNB |
자산 민팅 | N/A | 0.002 BNB | N
소유권 이전 | N/A | 0.002 BNB | N
자산 소각 | N/A | 0.002 BNB | N
자산 동결/해제 | N/A | 0.001 BNB | N
자산 잠금/해제/다시 잠금 | N/A | 0.002 BNB | N
자산 상장 | N/A | 200 BNB | N
Submit Proposal | N/A | 1 BNB | N
예치 | N/A | 0.000125 BNB | N
메모 체크 활성화 | N/A | 0.2 BNB | N
메모 체크 비활성화 | N/A | 0.2 BNB | N
HTLT | N/A | 0.000075 BNB | N
depositHTLT | N/A |  0.000075 BNB | N
claimHTLT | N/A |  0.000075 BNB | N
refundHTLT | N/A |  0.000075 BNB | N
refundHTLT | N/A |  0.000075 BNB | N
TinyIssueFee | N/A | 0.4 BNB | N
MiniIssueFee | N/A | 0.6 BNB | N
SetTokenUri | N/A| 0.000075 BNB | N
BEP8 토큰 상장 | N/A| 1 BNB | N
새로운 스마트 체인 검증인 생성 | N/A |2 BNB |N
스마트 체인 검증인 정보 수정 |N/A| 0.2 BNB |N
스마트 체인 검증인 위임 |N/A| 0.0002 BNB |N
스마트 체인 검증인 재위임 | N/A|0.0006 BNB |N
스마트 체인 검증인 위임 해제 | N/A|0.0004 BNB |N
스마트 체인 검증인 탈옥 | N/A| 0.5 BNB | N
스마트 체인 검증인 비잔틴 행동 증거 제출 | N/A| 0.5 BNB| N
스마트 체인 제안 제출 | N/A | 1 BNB    | N
스마트 체인 제안 예치 | N/A |0.00025 BNB | N
스마트 체인 제안 투표  | N/A | 0 BNB   | N
크로스 외부 전송 릴레이어 보상 | N/A | 0.0004 BNB    | N


### 메인넷 수수료 API

실시간으로 업데이트되는 시스템 수수료를 [여기](https://dex.binance.org/api/v1/fees)에서 확인하세요.


### 다중 전송 수수료

`bnbcli`는 여러가지 토큰을 여려 명에게 보낼 수 있는 다중 전송 명령을 지원합니다. `multi-send` 트랜잭션을 통해 각각 보내는 것 보다 비용이 20% 절감됩니다. 
현재는 `multi-send` 트랜잭션으로 하나의 주소에서 여러 출력 주소로 보내는 것이 가능합니다. 만일 출력 주소 개수가 임계치(2) 보다 크면, 총 트랜잭션 수수료는 주소 당 0.0003 BNB입니다.

예를 들어 3개의 ABC 토큰, 1개의 SAT 토큰과 1 ABC토큰을 서로 다른 3개의 주소로 보낼 때 아래와 같이 작성합니다.

```json
[
   {
      "to":"bnb1g5p04snezgpky203fq6da9qyjsy2k9kzr5yuhl",
      "amount":"100000000:BNB,100000000:ABC"
   },
   {
      "to":"bnb1l86xty0m55ryct9pnypz6chvtsmpyewmhrqwxw",
      "amount":"100000000:BNB"
   },
   {
      "to":"bnb1l86xty0maxdgst9pnypz6chvtsmpydkjflfioe",
      "amount":"100000000:BNB,100000000:SAT"
   }
]
```
다중 전송에 대해 메인넷/테스트넷에서 수수료를 지불합니다

```
0.0003 BNB * 5 = 0.0015 BNB
```

### 거래 수수료

거래 수수료는 복잡한 로직을 통해 작동하여 모든 거래가 아래 표 처럼 정확한 비율로 수수료가 책정되지 않고, 이들의 사이 값으로 책정됩니다. 
이는 DEX에서 사용하는 블록 기반 매칭 엔진을 사용하기 때문에 다음과 같이 작동합니다.

현제 거래 수수료는 다음과 같습니다:

트랜잭션 유형 | BNB 아닌 자산으로 결제 | BNB로 결제
-- | -- | --
거래 | 0.1% | 0.05%

거래수수료는 [여기](https://dex.binance.org/api/v1/fees?format=amino)에서 쿼리할 수 있습니다. "params/DexFeeParam/" 아래에 존재하며, "FeeRate"와 "FeeRateNative"는 10^-6 단위를 표현합니다.

### 테스트넷의 현재 수수료 표

수수료는 변수이며 거버넌스 제안 및 투표에 의해 변경될 수 있습니다. 해당 수수료 표는 **2021-03-17** 테스트넷 기준입니다:


트랜잭션 유형 | BNB 아닌 자산으로 결제 | BNB로 결제 | Exchange (DEX) 관련
-- | -- | -- | --
새 주문 | 0 | 0 | Y
취소 (No Fill) | 0.00005 BNB 환산 | 0.00001 BNB | Y
주문 만료 (No Fill) | 0.00005 BNB 환산 | 0.00001 BNB | Y
IOC (No Fill) | 0.00025 BNB 환산 | 0.000005 BNB | Y
전송 | N/A | 0.000075 BNB | N
crossTransferOut(크로스 전송) | N/A | 0.000075 BNB | N
Multi-send(다중 전송) | N/A | 0.00006 BNB | N
자산 발행 | N/A | 10 BNB |
자산 민팅 | N/A | 0.002 BNB | N
소유권 이전 | N/A | 0.002 BNB | N
자산 소간 | N/A | 0.002 BNB | N
자산 동결/해제 | N/A | 0.001 BNB | N
자산 잠금/해제/다시 잠금 | N/A | 0.002 BNB | N
자산 상장 | N/A | 200 BNB | N
제안 제출 | N/A | 1 BNB | N
예치 | N/A | 0.000125 BNB | N
메모 체크 활성화 | N/A | 0.2 BNB | N
메모 체크 비활성화 | N/A | 0.2 BNB | N
HTLT | N/A | 0.000075 BNB | N
depositHTLT | N/A |  0.000075 BNB | N
claimHTLT | N/A |  0.000075 BNB | N
refundHTLT | N/A |  0.000075 BNB | N
refundHTLT | N/A |  0.000075 BNB | N
TinyIssueFee | N/A | 0.4 BNB | N
MiniIssueFee | N/A | 0.6 BNB | N
SetTokenUri | N/A| 0.000075 BNB | N
BEP8 토큰 상장 | N/A| 1 BNB | N
새로운 스마트 체인 검증인 생성 | N/A |2 BNB |N
스마트 체인 검증인 정보 수정 | N/A | 0.2 BNB |N
스마트 체인 검증인 위임 | N/A | 0.0002 BNB |N
스마트 체인 검증인 재위임 | N/A |0.0006 BNB |N
스마트 체인 검증인 위임 해제 | N/A|0.0004 BNB |N
스마트 체인 검증인 탈옥 | N/A| 0.5 BNB | N
스마트 체인 검증인 비잔틴 행동 증거 제출 | N/A | 0.5 BNB| N
스마트 체인 제안 제출 | N/A | 1 BNB    | N
스마트 체인 제안 예치 | N/A |0.00025 BNB | N
스마트 체인 제안 투표   | N/A | 0 BNB   | N
크로스 외부 전송 릴레이어 보상  | N/A | 0.0004 BNB    | N


### 테스트넷 수수료 API

실시간으로 업데이트되는 시스템 수수료를 [여기](https://testnet-dex.binance.org/api/v1/fees)에서 확인하세요.

### 참고

- 거래 수수료의 경우 암묵적으로 결정되며, 다른 트랜잭션의 수수료들은 고정입니다.
It is free to send 새로운 GTE 주문을 보내거나, 일부 체결된 주문을 취소할 때 시스템이 일부 체결 주문(GTE나 IOC)을 만료시킬 때 수수료가 청구되지 않습니다.

- 거래와 관련 없는 트랜잭션이 발생하면 수수료를 지불해야 하며, BNB로만 결제할 수 있습니다. 트랜잭션은 충분한 BNB가 없으면 거절됩니다.

- 거래 관련 트랜잭션은 주문이 체결 되거나 부분 체결 없이 취소/만료/IOC-만료될 때 수수료가 청구됩니다. 지불하기 위한 BNB가 충분하다면, BNB 수수료 구조가 사용되고, 아니면 BNB아닌 수수료 구조를 사용하여 청구합니다.
- 모든 주문 값과 자유 잔고애 수수료를 지급하기 위한 금액이 부족할 때, 들어오는 모든 자산 및 잔여 잔액이 청구됩니다.
